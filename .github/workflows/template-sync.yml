name: Template Sync

on:
  # Monthly automatic sync (first day of month at midnight UTC)
  schedule:
    - cron: '0 0 1 * *'

  # Manual trigger (via GitHub Actions UI)
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (preview changes without creating PR)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  sync-template:
    runs-on: ubuntu-latest

    # Required permissions
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # Required: fetch full history for proper merge
          fetch-depth: 0

      - name: Sync with template repository
        uses: AndreasAugustin/actions-template-sync@v2
        with:
          # Source template repository
          source_repo_path: incubrain/founder-funnel

          # Target branch (uses repo default, usually 'main')
          upstream_branch: main

          # PR configuration
          pr_title: 'chore(template): sync upstream changes'
          pr_body: |
            ## üîÑ Template Sync

            This PR contains updates from the [Founder Funnel template](https://github.com/incubrain/founder-funnel).

            ### ‚ö†Ô∏è Review Checklist
            - [ ] Review changed files (focus on `shared/config/*` and root configs)
            - [ ] Check for breaking changes in dependencies
            - [ ] Verify `.env.example` for new variables
            - [ ] Test locally: `pnpm install && pnpm dev`

            ### üìù What to do
            1. **Review changes** ‚Äî Click "Files changed" tab
            2. **Resolve conflicts** ‚Äî If any exist (should be rare)
            3. **Test locally** ‚Äî Pull this branch and test
            4. **Merge** ‚Äî If everything looks good

            ### üîÑ Rollback
            If something breaks, just revert the merge commit.

            ---
            **Auto-generated by [actions-template-sync](https://github.com/AndreasAugustin/actions-template-sync)**

          pr_labels: template-sync,automated
          pr_commit_msg: 'chore(template): merge upstream changes'

          # Branch naming
          pr_branch_name_prefix: 'template-sync/'

          # Git user (for commits)
          git_user_name: 'github-actions[bot]'
          git_user_email: 'github-actions[bot]@users.noreply.github.com'

          # Dry run (from workflow input, defaults to false)
          is_dry_run: ${{ github.event.inputs.dry_run || 'false' }}

          # PR cleanup (close old template-sync PRs)
          is_pr_cleanup: true
          is_keep_branch_on_pr_cleanup: false
